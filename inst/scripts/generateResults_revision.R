# Running the model and storing outputs

library(data.table)
library(tidyverse)
library(git2r)
library(tictoc)
library(ggplot2)
library(patchwork)
library(cowplot)
library(latex2exp)
library(furrr)
library(sn)
library(ggrepel)
library(testthat)
library(svglite)

#########################
# General results (Figs 1b and 3c)

rm(list = ls())
devtools::load_all()
options(future.rng.onMisuse="ignore")

set.seed(210115)

no.samples <- 5000

# slow TTI (1 day each for test and trace)
# good implementation
scenarios1 <- tidyr::expand_grid(
  ## Put parameters that are grouped by disease into this data.frame
  delay_group = list(tibble::tibble(
    delay = c("Adherence"),
    delay_shape = c(0.7),
    delay_scale = 1
  )),
  inc_meanlog = 1.434065,
  inc_sdlog = 0.6612,
  inf_shape = 17.773185,
  inf_rate = 1.388388,
  inf_shift = 12.978985,
  min_quar_delay = 1,
  max_quar_delay = c(1),
  index_R0 = c(1.3,1.5),
  prop.asym = c(0.31),
  control_effectiveness = seq(0, 0.8, 0.2),
  self_report = c(0.5),
  iso_adhere = c(0.65),
  test_delay = c(1), #time from isolation to test result
  sensitivity = c(0.65,0.95), #percent of cases detected
  precaution = c(7), #this could be between 0 and 7? Number of days stay in isolation if negative test
  num.initial.cases = c(5),
  test_asym = c(FALSE)) %>%
  tidyr::unnest("delay_group") %>%
  dplyr::mutate(scenario = 1:dplyr::n())

cap_cases <- 2000
max_days <- 300
## Parameterise fixed parameters
sim_with_params <- purrr::partial(ringbp::scenario_sim,
                                  cap_max_days = max_days,
                                  cap_cases = cap_cases,
                                  r0isolated = 0,
                                  disp.iso = 1,
                                  disp.com = 0.23,
                                  quarantine = TRUE)

future::plan("multicore")

#+ full_run
tic()
## Run parameter sweep
sweep_results1 <- ringbp::parameter_sweep(scenarios1,
                                          sim_fn = sim_with_params,
                                          samples = no.samples,
                                          show_progress = TRUE,
                                          earlyOut=FALSE)
toc()


# #+ writeout
saveRDS(sweep_results1, file = "data-raw/res_Jan_1_fix.rds")
rm(list=ls())
Sys.sleep(120)

##################################################################

devtools::load_all()
options(future.rng.onMisuse="ignore")

set.seed(210115)

no.samples <- 5000

tic()
# medium speed TTI (1 day total for test and trace)
# good implementation
# testing asymptomatics: false
scenarios2 <- tidyr::expand_grid(
  ## Put parameters that are grouped by disease into this data.frame
  delay_group = list(tibble::tibble(
    delay = c("Adherence"),
    delay_shape = c(0.7),
    delay_scale = 1
  )),
  inc_meanlog = 1.434065,
  inc_sdlog = 0.6612,
  inf_shape = 17.773185,
  inf_rate = 1.388388,
  inf_shift = 12.978985,
  min_quar_delay = 0.5,
  max_quar_delay = c(0.5),
  index_R0 = c(1.3,1.5),
  prop.asym = c(0.31),
  control_effectiveness = seq(0, 0.8, 0.2),
  self_report = c(0.5),
  iso_adhere = c(0.65),
  test_delay = c(0.5), #time from isolation to test result
  sensitivity = c(0.65,0.95), #percent of cases detected
  precaution = c(7), #this could be between 0 and 7? Number of days stay in isolation if negative test
  num.initial.cases = c(5),
  test_asym = c(FALSE)) %>%
  tidyr::unnest("delay_group") %>%
  dplyr::mutate(scenario = 1:dplyr::n())

cap_cases <- 2000
max_days <- 300
## Parameterise fixed parameters
sim_with_params <- purrr::partial(ringbp::scenario_sim,
                                  cap_max_days = max_days,
                                  cap_cases = cap_cases,
                                  r0isolated = 0,
                                  disp.iso = 1,
                                  disp.com = 0.23,
                                  quarantine = TRUE)

future::plan("multicore")

#+ full_run
tic()
## Run parameter sweep
sweep_results2 <- ringbp::parameter_sweep(scenarios2,
                                          sim_fn = sim_with_params,
                                          samples = no.samples,
                                          show_progress = TRUE,
                                          earlyOut=FALSE)
toc()


# #+ writeout
saveRDS(sweep_results2, file = "data-raw/res_Jan_2_fix.rds")
rm(list=ls())
Sys.sleep(120)

##################################################################

devtools::load_all()
options(future.rng.onMisuse="ignore")

set.seed(210115)

no.samples <- 5000

tic()
# medium speed TTI (1 day total for test and trace)
# good implementation
# testing asymptomatics: true
scenarios2b <- tidyr::expand_grid(
  ## Put parameters that are grouped by disease into this data.frame
  delay_group = list(tibble::tibble(
    delay = c("Adherence"),
    delay_shape = c(0.7),
    delay_scale = 1
  )),
  inc_meanlog = 1.434065,
  inc_sdlog = 0.6612,
  inf_shape = 17.773185,
  inf_rate = 1.388388,
  inf_shift = 12.978985,
  min_quar_delay = 0.5,
  max_quar_delay = c(0.5),
  index_R0 = c(1.3),
  prop.asym = c(0.31),
  control_effectiveness = seq(0, 0.8, 0.2),
  self_report = c(0.5),
  iso_adhere = c(0.65),
  test_delay = c(0.5), #time from isolation to test result
  sensitivity = c(0.95), #percent of cases detected
  precaution = c(7), #this could be between 0 and 7? Number of days stay in isolation if negative test
  num.initial.cases = c(5),
  test_asym = c(TRUE)) %>%
  tidyr::unnest("delay_group") %>%
  dplyr::mutate(scenario = 1:dplyr::n())

cap_cases <- 2000
max_days <- 300
## Parameterise fixed parameters
sim_with_params <- purrr::partial(ringbp::scenario_sim,
                                  cap_max_days = max_days,
                                  cap_cases = cap_cases,
                                  r0isolated = 0,
                                  disp.iso = 1,
                                  disp.com = 0.23,
                                  quarantine = TRUE)

future::plan("multicore")

#+ full_run
tic()
## Run parameter sweep
sweep_results2b <- ringbp::parameter_sweep(scenarios2b,
                                          sim_fn = sim_with_params,
                                          samples = no.samples,
                                          show_progress = TRUE,
                                          earlyOut=FALSE)
toc()


# #+ writeout
saveRDS(sweep_results2b, file = "data-raw/res_Jan_2b_fix.rds")
rm(list=ls())
Sys.sleep(120)

##################################################################

devtools::load_all()
options(future.rng.onMisuse="ignore")

set.seed(210115)

no.samples <- 5000

# fast TTI (instant testing and tracing)
# good implementation
scenarios3 <- tidyr::expand_grid(
  ## Put parameters that are grouped by disease into this data.frame
  delay_group = list(tibble::tibble(
    delay = c("Adherence"),
    delay_shape = c(0.7),
    delay_scale = 1
  )),
  inc_meanlog = 1.434065,
  inc_sdlog = 0.6612,
  inf_shape = 17.773185,
  inf_rate = 1.388388,
  inf_shift = 12.978985,
  min_quar_delay = 0,
  max_quar_delay = c(0),
  index_R0 = c(1.3,1.5),
  prop.asym = c(0.31),
  control_effectiveness = seq(0, 0.8, 0.2),
  self_report = c(0.5),
  iso_adhere = c(0.65),
  test_delay = c(0), #time from isolation to test result
  sensitivity = c(0.65,0.95), #percent of cases detected
  precaution = c(7), #this could be between 0 and 7? Number of days stay in isolation if negative test
  num.initial.cases = c(5),
  test_asym = c(FALSE)) %>%
  tidyr::unnest("delay_group") %>%
  dplyr::mutate(scenario = 1:dplyr::n())

cap_cases <- 2000
max_days <- 300
## Parameterise fixed paramters
sim_with_params <- purrr::partial(ringbp::scenario_sim,
                                  cap_max_days = max_days,
                                  cap_cases = cap_cases,
                                  r0isolated = 0,
                                  disp.iso = 1,
                                  disp.com = 0.23,
                                  quarantine = TRUE)

future::plan("multicore")


#+ full_run
tic()
## Run parameter sweep
sweep_results3 <- ringbp::parameter_sweep(scenarios3,
                                          sim_fn = sim_with_params,
                                          samples = no.samples,
                                          show_progress = TRUE,
                                          earlyOut = FALSE)

toc()


# #+ writeout
saveRDS(sweep_results3, file = "data-raw/res_Jan_3_fix.rds")
rm(list=ls())

##################################################################

devtools::load_all()
options(future.rng.onMisuse="ignore")

set.seed(210115)

no.samples <- 5000

# slow TTI (1 day each for test and trace)
# poor adherence
scenarios4 <- tidyr::expand_grid(
  ## Put parameters that are grouped by disease into this data.frame
  delay_group = list(tibble::tibble(
    delay = c("Adherence"),
    delay_shape = c(0.182),
    delay_scale = 1
  )),
  inc_meanlog = 1.434065,
  inc_sdlog = 0.6612,
  inf_shape = 17.773185,
  inf_rate = 1.388388,
  inf_shift = 12.978985,
  min_quar_delay = 1,
  max_quar_delay = c(1),
  index_R0 = c(1.3,1.5),
  prop.asym = c(0.31),
  control_effectiveness = seq(0, 0.8, 0.2),
  self_report = c(0.119),
  iso_adhere = c(0.109),
  test_delay = c(1), #time from isolation to test result
  sensitivity = c(0.95), #percent of cases detected
  precaution = c(7), #this could be between 0 and 7? Number of days stay in isolation if negative test
  num.initial.cases = c(5),
  test_asym = c(FALSE)) %>%
  tidyr::unnest("delay_group") %>%
  dplyr::mutate(scenario = 1:dplyr::n())

cap_cases <- 2000
max_days <- 300
## Parameterise fixed paramters
sim_with_params <- purrr::partial(ringbp::scenario_sim,
                                  cap_max_days = max_days,
                                  cap_cases = cap_cases,
                                  r0isolated = 0,
                                  disp.iso = 1,
                                  disp.com = 0.23,
                                  quarantine = TRUE)

future::plan("multicore")

#+ full_run
tic()
## Run parameter sweep
sweep_results4 <- ringbp::parameter_sweep(scenarios4,
                                          sim_fn = sim_with_params,
                                          samples = no.samples,
                                          show_progress = TRUE,
                                          earlyOut = FALSE)

toc()


# #+ writeout
saveRDS(sweep_results4, file = "data-raw/res_Jan_4_fix.rds")
rm(list=ls())

##################################################################

devtools::load_all()
options(future.rng.onMisuse="ignore")

set.seed(210115)

no.samples <- 5000

# medium speed TTI (1 day total for test and trace)
# poor adherence
# testing asymptomatics: false
scenarios5 <- tidyr::expand_grid(
  ## Put parameters that are grouped by disease into this data.frame
  delay_group = list(tibble::tibble(
    delay = c("Adherence"),
    delay_shape = c(0.182),
    delay_scale = 1
  )),
  inc_meanlog = 1.434065,
  inc_sdlog = 0.6612,
  inf_shape = 17.773185,
  inf_rate = 1.388388,
  inf_shift = 12.978985,
  min_quar_delay = 0.5,
  max_quar_delay = c(0.5),
  index_R0 = c(1.3,1.5),
  prop.asym = c(0.31),
  control_effectiveness = seq(0, 0.8, 0.2),
  self_report = c(0.119),
  iso_adhere = c(0.109),
  test_delay = c(0.5), #time from isolation to test result
  sensitivity = c(0.95), #percent of cases detected
  precaution = c(7), #this could be between 0 and 7? Number of days stay in isolation if negative test
  num.initial.cases = c(5),
  test_asym = c(FALSE)) %>%
  tidyr::unnest("delay_group") %>%
  dplyr::mutate(scenario = 1:dplyr::n())


cap_cases <- 2000
max_days <- 300
## Parameterise fixed parameters
sim_with_params <- purrr::partial(ringbp::scenario_sim,
                                  cap_max_days = max_days,
                                  cap_cases = cap_cases,
                                  r0isolated = 0,
                                  disp.iso = 1,
                                  disp.com = 0.23,
                                  quarantine = TRUE)

future::plan("multicore")

#+ full_run
tic()
## Run parameter sweep
sweep_results5 <- ringbp::parameter_sweep(scenarios5,
                                          sim_fn = sim_with_params,
                                          samples = no.samples,
                                          show_progress = TRUE,
                                          earlyOut=FALSE)
toc()


# #+ writeout
saveRDS(sweep_results5, file = "data-raw/res_Jan_5_fix.rds")
rm(list=ls())
Sys.sleep(120)

##################################################################

devtools::load_all()
options(future.rng.onMisuse="ignore")

set.seed(210115)

no.samples <- 5000

# medium speed TTI (1 day total for test and trace)
# poor adherence
# testing asymptomatics: true
scenarios5b <- tidyr::expand_grid(
  ## Put parameters that are grouped by disease into this data.frame
  delay_group = list(tibble::tibble(
    delay = c("Adherence"),
    delay_shape = c(0.182),
    delay_scale = 1
  )),
  inc_meanlog = 1.434065,
  inc_sdlog = 0.6612,
  inf_shape = 17.773185,
  inf_rate = 1.388388,
  inf_shift = 12.978985,
  min_quar_delay = 0.5,
  max_quar_delay = c(0.5),
  index_R0 = c(1.3),
  prop.asym = c(0.31),
  control_effectiveness = seq(0, 0.8, 0.2),
  self_report = c(0.119),
  iso_adhere = c(0.109),
  test_delay = c(0.5), #time from isolation to test result
  sensitivity = c(0.95), #percent of cases detected
  precaution = c(7), #this could be between 0 and 7? Number of days stay in isolation if negative test
  num.initial.cases = c(5),
  test_asym = c(TRUE)) %>%
  tidyr::unnest("delay_group") %>%
  dplyr::mutate(scenario = 1:dplyr::n())

cap_cases <- 2000
max_days <- 300
## Parameterise fixed parameters
sim_with_params <- purrr::partial(ringbp::scenario_sim,
                                  cap_max_days = max_days,
                                  cap_cases = cap_cases,
                                  r0isolated = 0,
                                  disp.iso = 1,
                                  disp.com = 0.23,
                                  quarantine = TRUE)

future::plan("multicore")

#+ full_run
tic()
## Run parameter sweep
sweep_results5b <- ringbp::parameter_sweep(scenarios5b,
                                          sim_fn = sim_with_params,
                                          samples = no.samples,
                                          show_progress = TRUE,
                                          earlyOut=FALSE)
toc()


# #+ writeout
saveRDS(sweep_results5b, file = "data-raw/res_Jan_5b_fix.rds")
rm(list=ls())
Sys.sleep(120)

##################################################################

devtools::load_all()
options(future.rng.onMisuse="ignore")

set.seed(210115)

no.samples <- 5000

# fast TTI (instant testing and tracing)
# poor adherence
scenarios6 <- tidyr::expand_grid(
  ## Put parameters that are grouped by disease into this data.frame
  delay_group = list(tibble::tibble(
    delay = c("Adherence"),
    delay_shape = c(0.182),
    delay_scale = 1
  )),
  inc_meanlog = 1.434065,
  inc_sdlog = 0.6612,
  inf_shape = 17.773185,
  inf_rate = 1.388388,
  inf_shift = 12.978985,
  min_quar_delay = 0,
  max_quar_delay = c(0),
  index_R0 = c(1.3,1.5),
  prop.asym = c(0.31),
  control_effectiveness = seq(0, 0.8, 0.2),
  self_report = c(0.119),
  iso_adhere = c(0.109),
  test_delay = c(0), #time from isolation to test result
  sensitivity = c(0.95), #percent of cases detected
  precaution = c(7), #this could be between 0 and 7? Number of days stay in isolation if negative test
  num.initial.cases = c(5),
  test_asym = c(FALSE)) %>%
  tidyr::unnest("delay_group") %>%
  dplyr::mutate(scenario = 1:dplyr::n())

cap_cases <- 2000
max_days <- 300
## Parameterise fixed parameters
sim_with_params <- purrr::partial(ringbp::scenario_sim,
                                  cap_max_days = max_days,
                                  cap_cases = cap_cases,
                                  r0isolated = 0,
                                  disp.iso = 1,
                                  disp.com = 0.23,
                                  quarantine = TRUE)

future::plan("multicore")

#+ full_run
tic()
## Run parameter sweep
sweep_results6 <- ringbp::parameter_sweep(scenarios6,
                                          sim_fn = sim_with_params,
                                          samples = no.samples,
                                          show_progress = TRUE,
                                          earlyOut=FALSE)
toc()


# #+ writeout
saveRDS(sweep_results6, file = "data-raw/res_Jan_6_fix.rds")
rm(list=ls())
Sys.sleep(120)



##################################################################

devtools::load_all()
options(future.rng.onMisuse="ignore")

set.seed(210115)

no.samples <- 5000

# slow TTI (1 day each for test and trace)
# good adherence with boosted traced isolation adherence
scenarios7 <- tidyr::expand_grid(
  ## Put parameters that are grouped by disease into this data.frame
  delay_group = list(tibble::tibble(
    delay = c("Adherence"),
    delay_shape = c(0.7),
    delay_scale = 1
  )),
  inc_meanlog = 1.434065,
  inc_sdlog = 0.6612,
  inf_shape = 17.773185,
  inf_rate = 1.388388,
  inf_shift = 12.978985,
  min_quar_delay = 1,
  max_quar_delay = c(1),
  index_R0 = c(1.3,1.5),
  prop.asym = c(0.31),
  control_effectiveness = seq(0, 0.8, 0.2),
  self_report = c(0.5),
  iso_adhere = c(0.9),
  test_delay = c(1), #time from isolation to test result
  sensitivity = c(0.95), #percent of cases detected
  precaution = c(7), #this could be between 0 and 7? Number of days stay in isolation if negative test
  num.initial.cases = c(5),
  test_asym = c(FALSE)) %>%
  tidyr::unnest("delay_group") %>%
  dplyr::mutate(scenario = 1:dplyr::n())

cap_cases <- 2000
max_days <- 300
## Parameterise fixed parameters
sim_with_params <- purrr::partial(ringbp::scenario_sim,
                                  cap_max_days = max_days,
                                  cap_cases = cap_cases,
                                  r0isolated = 0,
                                  disp.iso = 1,
                                  disp.com = 0.23,
                                  quarantine = TRUE)

future::plan("multicore")

#+ full_run
tic()
## Run parameter sweep
sweep_results7 <- ringbp::parameter_sweep(scenarios7,
                                          sim_fn = sim_with_params,
                                          samples = no.samples,
                                          show_progress = TRUE,
                                          earlyOut=FALSE)
toc()


# #+ writeout
saveRDS(sweep_results7, file = "data-raw/res_Jan_7_fix.rds")
rm(list=ls())
Sys.sleep(120)

##################################################################

devtools::load_all()
options(future.rng.onMisuse="ignore")

set.seed(210115)

no.samples <- 5000

# medium speed TTI (1 day total for test and trace)
# good adherence with boosted traced isolation adherence
# testing asymptomatics: false
scenarios8 <- tidyr::expand_grid(
  ## Put parameters that are grouped by disease into this data.frame
  delay_group = list(tibble::tibble(
    delay = c("Adherence"),
    delay_shape = c(0.7),
    delay_scale = 1
  )),
  inc_meanlog = 1.434065,
  inc_sdlog = 0.6612,
  inf_shape = 17.773185,
  inf_rate = 1.388388,
  inf_shift = 12.978985,
  min_quar_delay = 0.5,
  max_quar_delay = c(0.5),
  index_R0 = c(1.3,1.5),
  prop.asym = c(0.31),
  control_effectiveness = seq(0, 0.8, 0.2),
  self_report = c(0.5),
  iso_adhere = c(0.9),
  test_delay = c(0.5), #time from isolation to test result
  sensitivity = c(0.95), #percent of cases detected
  precaution = c(7), #this could be between 0 and 7? Number of days stay in isolation if negative test
  num.initial.cases = c(5),
  test_asym = c(FALSE)) %>%
  tidyr::unnest("delay_group") %>%
  dplyr::mutate(scenario = 1:dplyr::n())

cap_cases <- 2000
max_days <- 300
## Parameterise fixed parameters
sim_with_params <- purrr::partial(ringbp::scenario_sim,
                                  cap_max_days = max_days,
                                  cap_cases = cap_cases,
                                  r0isolated = 0,
                                  disp.iso = 1,
                                  disp.com = 0.23,
                                  quarantine = TRUE)

future::plan("multicore")

#+ full_run
tic()
## Run parameter sweep
sweep_results8 <- ringbp::parameter_sweep(scenarios8,
                                          sim_fn = sim_with_params,
                                          samples = no.samples,
                                          show_progress = TRUE,
                                          earlyOut=FALSE)
toc()


# #+ writeout
saveRDS(sweep_results8, file = "data-raw/res_Jan_8_fix.rds")
rm(list=ls())
Sys.sleep(120)

##################################################################

devtools::load_all()
options(future.rng.onMisuse="ignore")

set.seed(210115)

no.samples <- 5000

# medium speed TTI (1 day total for test and trace)
# good adherence with boosted traced isolation adherence
# testing asymptomatics: true
scenarios8b <- tidyr::expand_grid(
  ## Put parameters that are grouped by disease into this data.frame
  delay_group = list(tibble::tibble(
    delay = c("Adherence"),
    delay_shape = c(0.7),
    delay_scale = 1
  )),
  inc_meanlog = 1.434065,
  inc_sdlog = 0.6612,
  inf_shape = 17.773185,
  inf_rate = 1.388388,
  inf_shift = 12.978985,
  min_quar_delay = 0.5,
  max_quar_delay = c(0.5),
  index_R0 = c(1.3),
  prop.asym = c(0.31),
  control_effectiveness = seq(0, 0.8, 0.2),
  self_report = c(0.5),
  iso_adhere = c(0.9),
  test_delay = c(0.5), #time from isolation to test result
  sensitivity = c(0.95), #percent of cases detected
  precaution = c(7), #this could be between 0 and 7? Number of days stay in isolation if negative test
  num.initial.cases = c(5),
  test_asym = c(TRUE)) %>%
  tidyr::unnest("delay_group") %>%
  dplyr::mutate(scenario = 1:dplyr::n())

cap_cases <- 2000
max_days <- 300
## Parameterise fixed parameters
sim_with_params <- purrr::partial(ringbp::scenario_sim,
                                  cap_max_days = max_days,
                                  cap_cases = cap_cases,
                                  r0isolated = 0,
                                  disp.iso = 1,
                                  disp.com = 0.23,
                                  quarantine = TRUE)

future::plan("multicore")

#+ full_run
tic()
## Run parameter sweep
sweep_results8b <- ringbp::parameter_sweep(scenarios8b,
                                          sim_fn = sim_with_params,
                                          samples = no.samples,
                                          show_progress = TRUE,
                                          earlyOut=FALSE)
toc()


# #+ writeout
saveRDS(sweep_results8b, file = "data-raw/res_Jan_8b_fix.rds")
rm(list=ls())
Sys.sleep(120)

##################################################################

rm(list = ls())
devtools::load_all()
options(future.rng.onMisuse="ignore")

set.seed(210115)

no.samples <- 5000

# fast TTI (instant testing and tracing)
# good adherence with boosted traced isolation adherence
scenarios9 <- tidyr::expand_grid(
  ## Put parameters that are grouped by disease into this data.frame
  delay_group = list(tibble::tibble(
    delay = c("Adherence"),
    delay_shape = c(0.7),
    delay_scale = 1
  )),
  inc_meanlog = 1.434065,
  inc_sdlog = 0.6612,
  inf_shape = 17.773185,
  inf_rate = 1.388388,
  inf_shift = 12.978985,
  min_quar_delay = 0,
  max_quar_delay = c(0),
  index_R0 = c(1.3,1.5),
  prop.asym = c(0.31),
  control_effectiveness = seq(0, 0.8, 0.2),
  self_report = c(0.5),
  iso_adhere = c(0.9),
  test_delay = c(0), #time from isolation to test result
  sensitivity = c(0.95), #percent of cases detected
  precaution = c(7), #this could be between 0 and 7? Number of days stay in isolation if negative test
  num.initial.cases = c(5),
  test_asym = c(FALSE)) %>%
  tidyr::unnest("delay_group") %>%
  dplyr::mutate(scenario = 1:dplyr::n())

cap_cases <- 2000
max_days <- 300
## Parameterise fixed parameters
sim_with_params <- purrr::partial(ringbp::scenario_sim,
                                  cap_max_days = max_days,
                                  cap_cases = cap_cases,
                                  r0isolated = 0,
                                  disp.iso = 1,
                                  disp.com = 0.23,
                                  quarantine = TRUE)

future::plan("multicore")

#+ full_run
tic()
## Run parameter sweep
sweep_results9 <- ringbp::parameter_sweep(scenarios9,
                                          sim_fn = sim_with_params,
                                          samples = no.samples,
                                          show_progress = TRUE,
                                          earlyOut=FALSE)
toc()


# #+ writeout
saveRDS(sweep_results9, file = "data-raw/res_Jan_9_fix.rds")
rm(list=ls())
Sys.sleep(120)

  ##################################################################

# Load in separate sets of scenarios and combine
sweep_results1 <- readRDS("data-raw/res_Jan_1_fix.rds")
sweep_results2 <- readRDS("data-raw/res_Jan_2_fix.rds")
sweep_results2b <- readRDS("data-raw/res_Jan_2b_fix.rds")
sweep_results3 <- readRDS("data-raw/res_Jan_3_fix.rds")
sweep_results4 <- readRDS("data-raw/res_Jan_4_fix.rds")
sweep_results5 <- readRDS("data-raw/res_Jan_5_fix.rds")
sweep_results5b <- readRDS("data-raw/res_Jan_5b_fix.rds")
sweep_results6 <- readRDS("data-raw/res_Jan_6_fix.rds")
sweep_results7 <- readRDS("data-raw/res_Jan_7_fix.rds")
sweep_results8 <- readRDS("data-raw/res_Jan_8_fix.rds")
sweep_results8b <- readRDS("data-raw/res_Jan_8b_fix.rds")
sweep_results9 <- readRDS("data-raw/res_Jan_9_fix.rds")
#

sweep_results <- as_tibble(rbind(sweep_results1,sweep_results2,sweep_results2b,sweep_results3,sweep_results4,sweep_results5,
                                sweep_results5b,sweep_results6,sweep_results7,sweep_results8,sweep_results8b,sweep_results9))

# Clear redundant data frames from working memory
sweep_results1 = sweep_results2 = sweep_results3 = sweep_results4 = sweep_results5 = sweep_results5b = sweep_results6 = sweep_results7 = sweep_results8 = sweep_results8b = sweep_results9 = sweep_results2b = c()

# Expand results for no testing so they can be filtered for plotting later on
# Same results hold for precaution =0,7 and test delay =0,2
# temp1 <- sweep_results %>% filter(sensitivity==0) %>%
#   mutate(precaution := 7)
# temp2 <- sweep_results %>% filter(sensitivity==0) %>%
#   mutate(precaution := 7) %>%
#   mutate(test_delay := 4)
# temp3 <- sweep_results %>% filter(sensitivity==0) %>%
#   mutate(test_delay := 4)
# temp <- rbind(temp1,temp2,temp3)
# sweep_results <- rbind(sweep_results,temp)
# temp = temp1 = temp2 = temp3 = c()
sweep_results$scenario <- 1:nrow(sweep_results)

no.samples <- 5000
cap_cases <- 2000
max_days <- 300

# # # Save final combined results (DONE)
saveRDS(sweep_results, file = "data-raw/res_Jan_complete_fix.rds")


#########################
# Missed Chains (Fig 3a and b):

# 5 initial cases

rm(list = ls())
devtools::load_all()

set.seed(200518)
no.samples <- 5000
seed.cases <- 5

scenarios <- tidyr::expand_grid(
  ## Put parameters that are grouped by disease into this data.frame
  delay_group = list(tibble::tibble(
    delay = c("Adherence"),
    delay_shape = c(0.06), # probability of self-isolation if symptomatic, assume == hospitalisation proportion
    delay_scale = 5.95402 # time from onset to self-isolation (i.e. hospitalisation)
  )),
  inc_meanlog = 1.434065,
  inc_sdlog = 0.6612,
  inf_shape = 17.773185,
  inf_rate = 1.388388,
  inf_shift = 12.978985,
  min_quar_delay = 1,
  max_quar_delay = c(1),
  index_R0 = c(1.1,1.3,1.5),
  prop.asym = c(0.4),
  control_effectiveness = 1,
  #self_report = proportion of self-isolating cases that self-report into tracing system
  # (assume only hospitalised cases "isolate"/detected, i.e. all isolating cases are reported)
  self_report = c(1),
  test_delay = c(0), #time from isolation to test result
  sensitivity = c(0), #sensitivity of test
  precaution = c(0), #this could be between 0 and 7? Number of days stay in isolation if negative test
  num.initial.cases = seed.cases) %>%
  tidyr::unnest("delay_group") %>%
  dplyr::mutate(scenario = 1:dplyr::n())

cap_cases <- 2000
max_days <- 50
## Parameterise fixed paramters
sim_with_params <- purrr::partial(ringbp::scenario_sim,
                                  cap_max_days = max_days,
                                  cap_cases = cap_cases,
                                  r0isolated = 0,
                                  disp.iso = 1,
                                  disp.com = 0.16,
                                  quarantine = TRUE)

#+ full_run
tic()
## Run parameter sweep
sweep_results <- ringbp::parameter_sweep(scenarios,
                                         sim_fn = sim_with_params,
                                         samples = no.samples,
                                         show_progress = TRUE,
                                         earlyOut = TRUE)
toc()

sweep_results$sims[[1]] <- sweep_results$sims[[1]] %>% group_by(sim) %>%
  mutate(early_missed = c(unique(early_missed),rep(NA,7))) %>%
  mutate(first_iso = c(unique(first_iso),rep(NA,7))) %>%
  mutate(index_R0 = paste(sweep_results$index_R0[1])) %>%
  ungroup()
sweep_results$sims[[2]] <- sweep_results$sims[[2]] %>% group_by(sim) %>%
  mutate(early_missed = c(unique(early_missed),rep(NA,7))) %>%
  mutate(first_iso = c(unique(first_iso),rep(NA,7))) %>%
  mutate(index_R0 = paste(sweep_results$index_R0[2])) %>%
  ungroup()
sweep_results$sims[[3]] <- sweep_results$sims[[3]] %>% group_by(sim) %>%
  mutate(early_missed = c(unique(early_missed),rep(NA,7))) %>%
  mutate(first_iso = c(unique(first_iso),rep(NA,7))) %>%
  mutate(index_R0 = paste(sweep_results$index_R0[3])) %>%
  ungroup()

saveRDS(sweep_results, file = "data-raw/res_Aug_missedChains_5cases.rds")

# 100 initial cases

rm(list = ls())
devtools::load_all()

set.seed(200518)
no.samples <- 5000
seed.cases <- 100

scenarios <- tidyr::expand_grid(
  ## Put parameters that are grouped by disease into this data.frame
  delay_group = list(tibble::tibble(
    delay = c("Adherence"),
    delay_shape = c(0.06), # probability of self-isolation if symptomatic, assume == hospitalisation proportion
    delay_scale = 5.95402 # time from onset to self-isolation (i.e. hospitalisation)
  )),
  inc_meanlog = 1.434065,
  inc_sdlog = 0.6612,
  inf_shape = 17.773185,
  inf_rate = 1.388388,
  inf_shift = 12.978985,
  min_quar_delay = 1,
  max_quar_delay = c(1),
  index_R0 = c(1.1,1.3,1.5),
  prop.asym = c(0.4),
  control_effectiveness = 1,
  #self_report = proportion of self-isolating cases that self-report into tracing system
  # (assume only hospitalised cases "isolate"/detected, i.e. all isolating cases are reported)
  self_report = c(1),
  test_delay = c(0), #time from isolation to test result
  sensitivity = c(0), #sensitivity of test
  precaution = c(0), #this could be between 0 and 7? Number of days stay in isolation if negative test
  num.initial.cases = seed.cases) %>%
  tidyr::unnest("delay_group") %>%
  dplyr::mutate(scenario = 1:dplyr::n())

cap_cases <- 2000
max_days <- 50
## Parameterise fixed paramters
sim_with_params <- purrr::partial(ringbp::scenario_sim,
                                  cap_max_days = max_days,
                                  cap_cases = cap_cases,
                                  r0isolated = 0,
                                  disp.iso = 1,
                                  disp.com = 0.16,
                                  quarantine = TRUE)

#+ full_run
tic()
## Run parameter sweep
sweep_results <- ringbp::parameter_sweep(scenarios,
                                         sim_fn = sim_with_params,
                                         samples = no.samples,
                                         show_progress = TRUE,
                                         earlyOut = TRUE)
toc()

sweep_results$sims[[1]] <- sweep_results$sims[[1]] %>% group_by(sim) %>%
  mutate(early_missed = c(unique(early_missed),rep(NA,7))) %>%
  mutate(first_iso = c(unique(first_iso),rep(NA,7))) %>%
  mutate(index_R0 = paste(sweep_results$index_R0[1])) %>%
  ungroup()
sweep_results$sims[[2]] <- sweep_results$sims[[2]] %>% group_by(sim) %>%
  mutate(early_missed = c(unique(early_missed),rep(NA,7))) %>%
  mutate(first_iso = c(unique(first_iso),rep(NA,7))) %>%
  mutate(index_R0 = paste(sweep_results$index_R0[2])) %>%
  ungroup()
sweep_results$sims[[3]] <- sweep_results$sims[[3]] %>% group_by(sim) %>%
  mutate(early_missed = c(unique(early_missed),rep(NA,7))) %>%
  mutate(first_iso = c(unique(first_iso),rep(NA,7))) %>%
  mutate(index_R0 = paste(sweep_results$index_R0[3])) %>%
  ungroup()

saveRDS(sweep_results, file = "data-raw/res_Aug_missedChains_100cases.rds")

#########################
# Perfect Tracing (Fig 2)

rm(list = ls())
devtools::load_all()

set.seed(200518)
no.samples <- 5000

scenarios <- tidyr::expand_grid(
  ## Put parameters that are grouped by disease into this data.frame
  delay_group = list(tibble::tibble(
    delay = c("Adherence"),
    delay_shape = c(0.9),
    delay_scale = 1
  )),
  inc_meanlog = 1.434065,
  inc_sdlog = 0.6612,
  inf_shape = 17.773185,
  inf_rate = 1.388388,
  inf_shift = 12.978985,
  min_quar_delay = 1,
  max_quar_delay = c(1),
  index_R0 = c(1.1,1.3,1.5),
  prop.asym = c(0.4),
  control_effectiveness = 1,
  self_report = c(0.5,1),
  test_delay = c(2), #time from isolation to test result
  sensitivity = c(0.65,0.95), #percent of cases detected
  precaution = c(7), #this could be between 0 and 7? Number of days stay in isolation if negative test
  num.initial.cases = c(5)) %>%
  tidyr::unnest("delay_group") %>%
  dplyr::mutate(scenario = 1:dplyr::n())

cap_cases <- 2000
max_days <- 300
## Parameterise fixed paramters
sim_with_params <- purrr::partial(ringbp::scenario_sim,
                                  cap_max_days = max_days,
                                  cap_cases = cap_cases,
                                  r0isolated = 0,
                                  disp.iso = 1,
                                  disp.com = 0.16,
                                  quarantine = TRUE)

#+ full_run
tic()
## Run parameter sweep
sweep_results <- ringbp::parameter_sweep(scenarios,
                                         sim_fn = sim_with_params,
                                         samples = no.samples,
                                         show_progress = TRUE,
                                         earlyOut = FALSE)
toc()

saveRDS(sweep_results, file = "data-raw/res_Aug_perfectTracing.rds")

